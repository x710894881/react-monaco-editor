{"ast":null,"code":"/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nimport { Position } from '../core/position.js';\nimport { PrefixSumComputer } from '../viewModel/prefixSumComputer.js';\n\nvar MirrorTextModel =\n/** @class */\nfunction () {\n  function MirrorTextModel(uri, lines, eol, versionId) {\n    this._uri = uri;\n    this._lines = lines;\n    this._eol = eol;\n    this._versionId = versionId;\n    this._lineStarts = null;\n  }\n\n  MirrorTextModel.prototype.dispose = function () {\n    this._lines.length = 0;\n  };\n\n  MirrorTextModel.prototype.getText = function () {\n    return this._lines.join(this._eol);\n  };\n\n  MirrorTextModel.prototype.onEvents = function (e) {\n    if (e.eol && e.eol !== this._eol) {\n      this._eol = e.eol;\n      this._lineStarts = null;\n    } // Update my lines\n\n\n    var changes = e.changes;\n\n    for (var _i = 0, changes_1 = changes; _i < changes_1.length; _i++) {\n      var change = changes_1[_i];\n\n      this._acceptDeleteRange(change.range);\n\n      this._acceptInsertText(new Position(change.range.startLineNumber, change.range.startColumn), change.text);\n    }\n\n    this._versionId = e.versionId;\n  };\n\n  MirrorTextModel.prototype._ensureLineStarts = function () {\n    if (!this._lineStarts) {\n      var eolLength = this._eol.length;\n      var linesLength = this._lines.length;\n      var lineStartValues = new Uint32Array(linesLength);\n\n      for (var i = 0; i < linesLength; i++) {\n        lineStartValues[i] = this._lines[i].length + eolLength;\n      }\n\n      this._lineStarts = new PrefixSumComputer(lineStartValues);\n    }\n  };\n  /**\n   * All changes to a line's text go through this method\n   */\n\n\n  MirrorTextModel.prototype._setLineText = function (lineIndex, newValue) {\n    this._lines[lineIndex] = newValue;\n\n    if (this._lineStarts) {\n      // update prefix sum\n      this._lineStarts.changeValue(lineIndex, this._lines[lineIndex].length + this._eol.length);\n    }\n  };\n\n  MirrorTextModel.prototype._acceptDeleteRange = function (range) {\n    if (range.startLineNumber === range.endLineNumber) {\n      if (range.startColumn === range.endColumn) {\n        // Nothing to delete\n        return;\n      } // Delete text on the affected line\n\n\n      this._setLineText(range.startLineNumber - 1, this._lines[range.startLineNumber - 1].substring(0, range.startColumn - 1) + this._lines[range.startLineNumber - 1].substring(range.endColumn - 1));\n\n      return;\n    } // Take remaining text on last line and append it to remaining text on first line\n\n\n    this._setLineText(range.startLineNumber - 1, this._lines[range.startLineNumber - 1].substring(0, range.startColumn - 1) + this._lines[range.endLineNumber - 1].substring(range.endColumn - 1)); // Delete middle lines\n\n\n    this._lines.splice(range.startLineNumber, range.endLineNumber - range.startLineNumber);\n\n    if (this._lineStarts) {\n      // update prefix sum\n      this._lineStarts.removeValues(range.startLineNumber, range.endLineNumber - range.startLineNumber);\n    }\n  };\n\n  MirrorTextModel.prototype._acceptInsertText = function (position, insertText) {\n    if (insertText.length === 0) {\n      // Nothing to insert\n      return;\n    }\n\n    var insertLines = insertText.split(/\\r\\n|\\r|\\n/);\n\n    if (insertLines.length === 1) {\n      // Inserting text on one line\n      this._setLineText(position.lineNumber - 1, this._lines[position.lineNumber - 1].substring(0, position.column - 1) + insertLines[0] + this._lines[position.lineNumber - 1].substring(position.column - 1));\n\n      return;\n    } // Append overflowing text from first line to the end of text to insert\n\n\n    insertLines[insertLines.length - 1] += this._lines[position.lineNumber - 1].substring(position.column - 1); // Delete overflowing text from first line and insert text on first line\n\n    this._setLineText(position.lineNumber - 1, this._lines[position.lineNumber - 1].substring(0, position.column - 1) + insertLines[0]); // Insert new lines & store lengths\n\n\n    var newLengths = new Uint32Array(insertLines.length - 1);\n\n    for (var i = 1; i < insertLines.length; i++) {\n      this._lines.splice(position.lineNumber + i - 1, 0, insertLines[i]);\n\n      newLengths[i - 1] = insertLines[i].length + this._eol.length;\n    }\n\n    if (this._lineStarts) {\n      // update prefix sum\n      this._lineStarts.insertValues(position.lineNumber, newLengths);\n    }\n  };\n\n  return MirrorTextModel;\n}();\n\nexport { MirrorTextModel };","map":null,"metadata":{},"sourceType":"module"}