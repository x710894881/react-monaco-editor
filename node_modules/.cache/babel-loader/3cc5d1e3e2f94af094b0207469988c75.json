{"ast":null,"code":"/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n'use strict';\n\nimport { DocumentHighlightKind, Location, Range, SymbolKind, TextEdit } from '../../vscode-languageserver-types/main.js';\nimport * as nls from '../../../fillers/vscode-nls.js';\nimport * as nodes from '../parser/cssNodes.js';\nimport { Symbols } from '../parser/cssSymbolScope.js';\nimport { getColorValue, hslFromColor } from '../languageFacts/facts.js';\nimport { endsWith, startsWith } from '../utils/strings.js';\nvar localize = nls.loadMessageBundle();\n\nvar CSSNavigation =\n/** @class */\nfunction () {\n  function CSSNavigation() {}\n\n  CSSNavigation.prototype.findDefinition = function (document, position, stylesheet) {\n    var symbols = new Symbols(stylesheet);\n    var offset = document.offsetAt(position);\n    var node = nodes.getNodeAtOffset(stylesheet, offset);\n\n    if (!node) {\n      return null;\n    }\n\n    var symbol = symbols.findSymbolFromNode(node);\n\n    if (!symbol) {\n      return null;\n    }\n\n    return {\n      uri: document.uri,\n      range: getRange(symbol.node, document)\n    };\n  };\n\n  CSSNavigation.prototype.findReferences = function (document, position, stylesheet) {\n    var highlights = this.findDocumentHighlights(document, position, stylesheet);\n    return highlights.map(function (h) {\n      return {\n        uri: document.uri,\n        range: h.range\n      };\n    });\n  };\n\n  CSSNavigation.prototype.findDocumentHighlights = function (document, position, stylesheet) {\n    var result = [];\n    var offset = document.offsetAt(position);\n    var node = nodes.getNodeAtOffset(stylesheet, offset);\n\n    if (!node || node.type === nodes.NodeType.Stylesheet || node.type === nodes.NodeType.Declarations) {\n      return result;\n    }\n\n    if (node.type === nodes.NodeType.Identifier && node.parent && node.parent.type === nodes.NodeType.ClassSelector) {\n      node = node.parent;\n    }\n\n    var symbols = new Symbols(stylesheet);\n    var symbol = symbols.findSymbolFromNode(node);\n    var name = node.getText();\n    stylesheet.accept(function (candidate) {\n      if (symbol) {\n        if (symbols.matchesSymbol(candidate, symbol)) {\n          result.push({\n            kind: getHighlightKind(candidate),\n            range: getRange(candidate, document)\n          });\n          return false;\n        }\n      } else if (node.type === candidate.type && node.length === candidate.length && name === candidate.getText()) {\n        // Same node type and data\n        result.push({\n          kind: getHighlightKind(candidate),\n          range: getRange(candidate, document)\n        });\n      }\n\n      return true;\n    });\n    return result;\n  };\n\n  CSSNavigation.prototype.findDocumentLinks = function (document, stylesheet, documentContext) {\n    var result = [];\n    stylesheet.accept(function (candidate) {\n      if (candidate.type === nodes.NodeType.URILiteral) {\n        var link = uriLiteralNodeToDocumentLink(document, candidate, documentContext);\n\n        if (link) {\n          result.push(link);\n        }\n\n        return false;\n      }\n      /**\n       * In @import, it is possible to include links that do not use `url()`\n       * For example, `@import 'foo.css';`\n       */\n\n\n      if (candidate.parent && candidate.parent.type === nodes.NodeType.Import) {\n        var rawText = candidate.getText();\n\n        if (startsWith(rawText, \"'\") || startsWith(rawText, \"\\\"\")) {\n          result.push(uriStringNodeToDocumentLink(document, candidate, documentContext));\n        }\n\n        return false;\n      }\n\n      return true;\n    });\n    return result;\n  };\n\n  CSSNavigation.prototype.findDocumentSymbols = function (document, stylesheet) {\n    var result = [];\n    stylesheet.accept(function (node) {\n      var entry = {\n        name: null,\n        kind: SymbolKind.Class,\n        location: null\n      };\n      var locationNode = node;\n\n      if (node instanceof nodes.Selector) {\n        entry.name = node.getText();\n        locationNode = node.findAParent(nodes.NodeType.Ruleset, nodes.NodeType.ExtendsReference);\n\n        if (locationNode) {\n          entry.location = Location.create(document.uri, getRange(locationNode, document));\n          result.push(entry);\n        }\n\n        return false;\n      } else if (node instanceof nodes.VariableDeclaration) {\n        entry.name = node.getName();\n        entry.kind = SymbolKind.Variable;\n      } else if (node instanceof nodes.MixinDeclaration) {\n        entry.name = node.getName();\n        entry.kind = SymbolKind.Method;\n      } else if (node instanceof nodes.FunctionDeclaration) {\n        entry.name = node.getName();\n        entry.kind = SymbolKind.Function;\n      } else if (node instanceof nodes.Keyframe) {\n        entry.name = localize('literal.keyframes', \"@keyframes {0}\", node.getName());\n      } else if (node instanceof nodes.FontFace) {\n        entry.name = localize('literal.fontface', \"@font-face\");\n      }\n\n      if (entry.name) {\n        entry.location = Location.create(document.uri, getRange(locationNode, document));\n        result.push(entry);\n      }\n\n      return true;\n    });\n    return result;\n  };\n\n  CSSNavigation.prototype.findDocumentColors = function (document, stylesheet) {\n    var result = [];\n    stylesheet.accept(function (node) {\n      var colorInfo = getColorInformation(node, document);\n\n      if (colorInfo) {\n        result.push(colorInfo);\n      }\n\n      return true;\n    });\n    return result;\n  };\n\n  CSSNavigation.prototype.getColorPresentations = function (document, stylesheet, color, range) {\n    var result = [];\n    var red256 = Math.round(color.red * 255),\n        green256 = Math.round(color.green * 255),\n        blue256 = Math.round(color.blue * 255);\n    var label;\n\n    if (color.alpha === 1) {\n      label = \"rgb(\" + red256 + \", \" + green256 + \", \" + blue256 + \")\";\n    } else {\n      label = \"rgba(\" + red256 + \", \" + green256 + \", \" + blue256 + \", \" + color.alpha + \")\";\n    }\n\n    result.push({\n      label: label,\n      textEdit: TextEdit.replace(range, label)\n    });\n\n    if (color.alpha === 1) {\n      label = \"#\" + toTwoDigitHex(red256) + toTwoDigitHex(green256) + toTwoDigitHex(blue256);\n    } else {\n      label = \"#\" + toTwoDigitHex(red256) + toTwoDigitHex(green256) + toTwoDigitHex(blue256) + toTwoDigitHex(Math.round(color.alpha * 255));\n    }\n\n    result.push({\n      label: label,\n      textEdit: TextEdit.replace(range, label)\n    });\n    var hsl = hslFromColor(color);\n\n    if (hsl.a === 1) {\n      label = \"hsl(\" + hsl.h + \", \" + Math.round(hsl.s * 100) + \"%, \" + Math.round(hsl.l * 100) + \"%)\";\n    } else {\n      label = \"hsla(\" + hsl.h + \", \" + Math.round(hsl.s * 100) + \"%, \" + Math.round(hsl.l * 100) + \"%, \" + hsl.a + \")\";\n    }\n\n    result.push({\n      label: label,\n      textEdit: TextEdit.replace(range, label)\n    });\n    return result;\n  };\n\n  CSSNavigation.prototype.doRename = function (document, position, newName, stylesheet) {\n    var _a;\n\n    var highlights = this.findDocumentHighlights(document, position, stylesheet);\n    var edits = highlights.map(function (h) {\n      return TextEdit.replace(h.range, newName);\n    });\n    return {\n      changes: (_a = {}, _a[document.uri] = edits, _a)\n    };\n  };\n\n  return CSSNavigation;\n}();\n\nexport { CSSNavigation };\n\nfunction getColorInformation(node, document) {\n  var color = getColorValue(node);\n\n  if (color) {\n    var range = getRange(node, document);\n    return {\n      color: color,\n      range: range\n    };\n  }\n\n  return null;\n}\n\nfunction uriLiteralNodeToDocumentLink(document, uriLiteralNode, documentContext) {\n  if (uriLiteralNode.getChildren().length === 0) {\n    return null;\n  }\n\n  var uriStringNode = uriLiteralNode.getChild(0);\n  return uriStringNodeToDocumentLink(document, uriStringNode, documentContext);\n}\n\nfunction uriStringNodeToDocumentLink(document, uriStringNode, documentContext) {\n  var rawUri = uriStringNode.getText();\n  var range = getRange(uriStringNode, document); // Make sure the range is not empty\n\n  if (range.start.line === range.end.line && range.start.character === range.end.character) {\n    return null;\n  }\n\n  if (startsWith(rawUri, \"'\") || startsWith(rawUri, \"\\\"\")) {\n    rawUri = rawUri.slice(1, -1);\n  }\n\n  var target;\n\n  if (startsWith(rawUri, 'http://') || startsWith(rawUri, 'https://')) {\n    target = rawUri;\n  } else if (/^\\w+:\\/\\//g.test(rawUri)) {\n    target = rawUri;\n  } else {\n    /**\n     * In SCSS, @import 'foo' could be referring to `_foo.scss`, if none of the following is true:\n     * - The file's extension is .css.\n     * - The filename begins with http://.\n     * - The filename is a url().\n     * - The @import has any media queries.\n     */\n    if (document.languageId === 'scss') {\n      if (!endsWith(rawUri, '.css') && !startsWith(rawUri, 'http://') && !startsWith(rawUri, 'https://') && !(uriStringNode.parent && uriStringNode.parent.type === nodes.NodeType.URILiteral) && uriStringNode.parent.getChildren().length === 1) {\n        target = toScssPartialUri(documentContext.resolveReference(rawUri, document.uri));\n      } else {\n        target = documentContext.resolveReference(rawUri, document.uri);\n      }\n    } else {\n      target = documentContext.resolveReference(rawUri, document.uri);\n    }\n  }\n\n  return {\n    range: range,\n    target: target\n  };\n}\n\nfunction toScssPartialUri(uri) {\n  return uri.replace(/\\/(\\w+)(.scss)?$/gm, function (match, fileName) {\n    return '/_' + fileName + '.scss';\n  });\n}\n\nfunction getRange(node, document) {\n  return Range.create(document.positionAt(node.offset), document.positionAt(node.end));\n}\n\nfunction getHighlightKind(node) {\n  if (node.type === nodes.NodeType.Selector) {\n    return DocumentHighlightKind.Write;\n  }\n\n  if (node instanceof nodes.Identifier) {\n    if (node.parent && node.parent instanceof nodes.Property) {\n      if (node.isCustomProperty) {\n        return DocumentHighlightKind.Write;\n      }\n    }\n  }\n\n  if (node.parent) {\n    switch (node.parent.type) {\n      case nodes.NodeType.FunctionDeclaration:\n      case nodes.NodeType.MixinDeclaration:\n      case nodes.NodeType.Keyframe:\n      case nodes.NodeType.VariableDeclaration:\n      case nodes.NodeType.FunctionParameter:\n        return DocumentHighlightKind.Write;\n    }\n  }\n\n  return DocumentHighlightKind.Read;\n}\n\nfunction toTwoDigitHex(n) {\n  var r = n.toString(16);\n  return r.length !== 2 ? '0' + r : r;\n}","map":null,"metadata":{},"sourceType":"module"}